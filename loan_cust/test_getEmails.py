import requests as rq
from .db_config import FAT_CUST
from .db_init import MySQLClient
"""
批量查询邮箱接口测试, 使用pytest执行，pytest loan_cust/
https://metis2.hellobike.cn/team/detail/issue?filterId=358678&openDetail=564738&teamId=207
"""

custNos = {
  "custNos": [
    "800000068015",
    "800000030503",
    "800000068013",
    "800000068012",
    "800000068011",
    "800000068010",
    "800000068009",
    "800000068008",
    "800000068007",
    "800000068006",
    "800000068005",
    "800000068004",
    "800000068003",
    "800000068002",
    "800000068001",
    "800000067501",
    "800000067013",
    "800000067012",
    "800000067011",
    "800000067010",
    "800000067009",
    "800000067008",
    "800000067007",
    "800000067006",
    "800000067005",
    "800000067004",
    "800000067003",
    "800000067002",
    "800000064502",
    "800000067001",
    "800000066525",
    "800000066524",
    "800000066523",
    "800000066522",
    "800000066521",
    "800000066520",
    "800000066519",
    "800000066518",
    "800000066517",
    "800000066516",
    "800000066515",
    "800000066514",
    "800000066513",
    "800000066512",
    "800000066511",
    "800000066510",
    "800000066509",
    "800000066508",
    "800000066507",
    "800000066505",
    "800000066504",
    "800000066503",
    "800000066502",
    "800000066501",
    "800000066014",
    "800000066013",
    "800000066011",
    "800000066009",
    "800000066008",
    "800000064501",
    "800000066004",
    "800000066003",
    "800000066002",
    "800000066001",
    "800000065516",
    "800000065513",
    "800000065510",
    "800000065509",
    "800000065508",
    "800000065507",
    "800000065506",
    "800000065505",
    "800000065504",
    "800000065503",
    "800000065502",
    "800000065501",
    "800000065007",
    "800000065006",
    "800000065002",
    "800000065001",
    "800000064002",
    "800000064001",
    "800000063502",
    "800000063501",
    "800000063010",
    "800000063009",
    "800000063007",
    "800000063006",
    "800000063005",
    "800000063004",
    "800000063003",
    "800000063002",
    "800000062001",
    "800000061503",
    "800000061502",
    "800000061501",
    "800000061003",
    "800000061001",
    "800000060520",
    "800000060519",
    # "800000060518",
    # "800000060517"
  ]
}
headers = {"content-type": "application/json", "Accept-Charset": "*/*"}


db = MySQLClient(FAT_CUST)
def sqlEmail(cust_no)-> str:
  """ 根据cust_no查出数据库中对应email"""
  sql = ("select email from cust_personal_info where cust_no=%s", cust_no,)
  res = db.query(*sql)
  return res[0][0]


url = "http://apidoc-fat.sandbox-shuangqiang.top/loancust/personalInfo/getEmails"
def test_getEmails():
    """ 验证接口返回的 数据是否 数据库一致"""
    response = rq.post(url, json=custNos, headers=headers)
    # print('请求内容：',response.request.body)
    # print('响应内容:', response.json())
    result = response.json()
    assert result["retCode"] == "000000"
    for item in result["data"]["emails"]:
      expires = sqlEmail(item["custNo"])
      print(f"实际结果:{item['email']}, 预期结果：{expires}")
      assert item["email"] == expires

